<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Tareas APIREST (CRUD Completo)</title>
    <style>
        /* Estilos Generales */
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background-color: #f4f7f6;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        /* Estilos del Formulario */
        
        .form-container {
            background: white;
            padding: 20px;
            margin: 0 auto 30px auto;
            max-width: 900px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .form-group {
            grid-column: span 1;
        }
        
        .full-width {
            grid-column: span 3;
        }
        
        input,
        select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 90%;
            box-sizing: border-box;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
            font-size: 0.9em;
        }
        /* Estilos de Botones */
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }
        
        .btn-guardar {
            background-color: #28a745;
            color: white;
            grid-column: span 3;
            margin-top: 10px;
        }
        
        .btn-guardar:hover {
            background-color: #218838;
        }
        
        .btn-limpiar {
            background-color: #6c757d;
            color: white;
            grid-column: span 3;
            margin-top: 5px;
        }
        /* Estilos de la Tabla */
        
        table {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #007bff;
            color: white;
        }
        
        tr:hover {
            background-color: #f1f1f1;
        }
        /* Botones de acci√≥n en la tabla */
        
        .btn-edit {
            background-color: #ffc107;
            color: #333;
            padding: 5px 10px;
            font-size: 0.8em;
            margin-right: 5px;
        }
        
        .btn-del {
            background-color: #dc3545;
            color: white;
            padding: 5px 10px;
            font-size: 0.8em;
        }
        
        .btn-del:hover {
            background-color: #c82333;
        }
        
        .btn-edit:hover {
            background-color: #e0a800;
        }
        
        .message {
            text-align: center;
            padding: 10px;
            font-weight: bold;
        }
        
        .error {
            color: red;
        }
    </style>
</head>

<body>

    <h1>Gesti√≥n de Tareas APIREST (CRUD) üìã</h1>

    <div class="form-container">
        <input type="hidden" id="inputIdOriginal">

        <div class="form-group">
            <label for="inputId">ID Tarea (Obligatorio):</label>
            <input type="text" id="inputId" placeholder="Ej: 10" required>
        </div>
        <div class="form-group">
            <label for="inputPrioridad">Prioridad:</label>
            <input type="number" id="inputPrioridad" placeholder="Ej: 10">
        </div>
        <div class="form-group">
            <label for="inputResponsable">Responsable:</label>
            <input type="text" id="inputResponsable" placeholder="Nombre">
        </div>

        <div class="full-width">
            <label for="inputTarea">Descripci√≥n de la Tarea:</label>
            <input type="text" id="inputTarea" placeholder="Ej: Comprar material oficina" required>
        </div>

        <div class="form-group">
            <label for="inputUrgente">Urgente:</label>
            <select id="inputUrgente">
                <option value="true">S√≠</option>
                <option value="false" selected>No</option>
            </select>
        </div>
        <div class="form-group">
            <label for="inputRealizada">Realizada:</label>
            <select id="inputRealizada">
                <option value="true">S√≠</option>
                <option value="false" selected>No</option>
            </select>
        </div>
        <div class="form-group">
        </div>

        <button class="btn-guardar" onclick="guardarDatos()" id="btnAccion">CREAR TAREA (POST) ‚ú®</button>
        <button class="btn-limpiar" onclick="limpiarFormulario()">Limpiar / Cancelar</button>
    </div>

    <div id="tabla-container">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Tarea</th>
                    <th>Prioridad</th>
                    <th>Urgente</th>
                    <th>Estado</th>
                    <th>Responsable</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="cuerpoTabla">
            </tbody>
        </table>
    </div>

    <script>
        // CONFIGURACI√ìN DE LA API
        const IP = "192.168.1.120"; // ‚ö†Ô∏è VERIFICA y CAMBIA la IP si es necesario
        const PORT = "8069";
        const URL_BASE = `http://${IP}:${PORT}`;
        const ENDPOINT_LISTAR = '/listartareas';
        const ENDPOINT_CRUD = '/gestion/lista_tareas.lista_tareas';

        // --- FUNCIONES CORE CRUD ---

        // 1. READ (GET) - Cargar y mostrar datos
        function cargarTareas() {
            const tbody = document.getElementById('cuerpoTabla');
            tbody.innerHTML = '<tr><td colspan="7" class="message">Cargando datos...</td></tr>';

            fetch(URL_BASE + ENDPOINT_LISTAR)
                .then(res => res.json())
                .then(datos => {
                    tbody.innerHTML = '';

                    // Se asume que los datos son un array de arrays: [id, tarea, prioridad, urgente, realizada, responsable]
                    datos.forEach(item => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${item[0]}</td>
                                <td>${item[1]}</td>
                                <td>${item[2]}</td>
                                <td>${item[3]}</td>
                                <td>${item[4]}</td>
                                <td>${item[5]}</td>
                                <td>
                                    <button class="btn-edit" onclick="prepararEdicion(${JSON.stringify(item).replace(/'/g, "\\'")})">Editar</button>
                                    <button class="btn-del" onclick="borrarTarea('${item[0]}')">Borrar</button>
                                </td>
                            </tr>
                        `;
                    });
                    if (datos.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="message">No hay tareas registradas.</td></tr>';
                    }
                })
                .catch(err => {
                    console.error("Error de conexi√≥n:", err);
                    tbody.innerHTML = '<tr><td colspan="7" class="message error">‚õî Error de conexi√≥n con la API. Aseg√∫rate de que el servidor est√° activo.</td></tr>';
                });
        }

        // 2. DELETE - Eliminar una tarea
        function borrarTarea(id) {
            if (!confirm(`¬øEst√°s seguro de que quieres borrar la tarea ID: ${id}?`)) return;

            const dataStr = JSON.stringify({
                "id": id
            });

            fetch(`${URL_BASE}${ENDPOINT_CRUD}?data=${dataStr}`, {
                    method: 'DELETE'
                })
                .then(res => {
                    if (res.ok) {
                        cargarTareas();
                        alert(`Tarea ID ${id} eliminada.`);
                    } else {
                        alert("Error al borrar. La API no respondi√≥ correctamente.");
                    }
                })
                .catch(err => console.error("Error DELETE:", err));
        }

        // 3 & 4. CREATE (POST) / UPDATE (PUT) - Guardar datos
        function guardarDatos() {
            // Recoger valores del formulario
            const id = document.getElementById('inputId').value;
            const tarea = document.getElementById('inputTarea').value;
            const prioridad = document.getElementById('inputPrioridad').value;
            // Los select devuelven el string del valor (true/false)
            const urgente = document.getElementById('inputUrgente').value;
            const realizada = document.getElementById('inputRealizada').value;
            const responsable = document.getElementById('inputResponsable').value;

            if (!id || !tarea) {
                alert("El ID y la Tarea son campos obligatorios.");
                return;
            }

            // Determinar si estamos editando (PUT) o creando (POST)
            const idOriginal = document.getElementById('inputIdOriginal').value;
            const esEdicion = idOriginal !== "";

            // Objeto de datos (CLAVES IMPORTANTES: deben coincidir con tu API)
            const objetoDatos = {
                "id": id,
                "task": tarea,
                "prioridad": prioridad,
                "urgente": urgente,
                "realizada": realizada,
                "responsable": responsable
            };

            const dataStr = JSON.stringify(objetoDatos);

            let method = esEdicion ? 'PUT' : 'POST';

            fetch(`${URL_BASE}${ENDPOINT_CRUD}?data=${dataStr}`, {
                    method: method
                })
                .then(res => {
                    if (!res.ok) {
                        // Intenta leer el mensaje de error del servidor
                        return res.json().then(err => {
                            throw new Error(err.message || `HTTP error! Status: ${res.status}`);
                        });
                    }
                    return res.json();
                })
                .then(data => {
                    alert(`Tarea ${esEdicion ? 'actualizada (PUT)' : 'creada (POST)'} con √©xito.`);
                    limpiarFormulario();
                    cargarTareas(); // Recargar tabla
                })
                .catch(error => {
                    console.error(`Error ${method}:`, error);
                    alert(`Fallo en la operaci√≥n ${method}. Revisa la consola.`);
                });
        }

        // --- FUNCIONES AUXILIARES ---

        // Prepara el formulario para editar (se llama desde el bot√≥n "Editar")
        function prepararEdicion(itemArray) {
            // itemArray es [id, tarea, prioridad, urgente, realizada, responsable]

            // 1. Marcar modo edici√≥n
            document.getElementById('inputIdOriginal').value = itemArray[0];

            // 2. Rellenar campos
            document.getElementById('inputId').value = itemArray[0];
            document.getElementById('inputTarea').value = itemArray[1];
            document.getElementById('inputPrioridad').value = itemArray[2];
            document.getElementById('inputUrgente').value = itemArray[3];
            document.getElementById('inputRealizada').value = itemArray[4];
            document.getElementById('inputResponsable').value = itemArray[5];

            // 3. Cambiar bot√≥n
            const btn = document.getElementById('btnAccion');
            btn.innerText = "GUARDAR CAMBIOS (PUT) üíæ";
            btn.style.backgroundColor = "#ffc107"; // Amarillo
            btn.style.color = "black";

            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // Limpia el formulario y resetea el modo a 'Crear'
        function limpiarFormulario() {
            document.getElementById('inputIdOriginal').value = ""; // Reseteamos modo edici√≥n

            document.getElementById('inputId').value = "";
            document.getElementById('inputTarea').value = "";
            document.getElementById('inputPrioridad').value = "";
            document.getElementById('inputResponsable').value = "";
            document.getElementById('inputUrgente').value = "false";
            document.getElementById('inputRealizada').value = "false";

            // Resetear bot√≥n a modo CREAR
            const btn = document.getElementById('btnAccion');
            btn.innerText = "CREAR TAREA (POST) ‚ú®";
            btn.style.backgroundColor = "#28a745"; // Verde
            btn.style.color = "white";
        }

        // Iniciar al cargar la p√°gina
        window.onload = cargarTareas;
    </script>
</body>

</html>